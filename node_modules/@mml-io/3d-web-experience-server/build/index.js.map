{
  "version": 3,
  "sources": ["../src/MMLDocumentsServer.ts", "../src/Networked3dWebExperienceServer.ts", "../src/websocketDirectoryChangeListener.ts"],
  "sourcesContent": ["import fs from \"node:fs\";\nimport path from \"node:path\";\nimport url from \"node:url\";\n\nimport { EditableNetworkedDOM, LocalObservableDOMFactory } from \"@mml-io/networked-dom-server\";\nimport { watch, FSWatcher } from \"chokidar\";\nimport micromatch from \"micromatch\";\nimport WebSocket from \"ws\";\n\nconst getMmlDocumentContent = (documentPath: string) => {\n  return fs.readFileSync(documentPath, { encoding: \"utf8\", flag: \"r\" });\n};\n\nexport class MMLDocumentsServer {\n  private documents = new Map<\n    string,\n    {\n      documentPath: string;\n      document: EditableNetworkedDOM;\n    }\n  >();\n  private watcher: FSWatcher;\n  private watchPattern: string;\n\n  constructor(\n    private directory: string,\n    watchPattern: string,\n  ) {\n    this.watchPattern = watchPattern;\n    this.watch();\n  }\n\n  public dispose() {\n    for (const { document } of this.documents.values()) {\n      document.dispose();\n    }\n    this.documents.clear();\n    this.watcher.close();\n  }\n\n  public handle(filename: string, ws: WebSocket) {\n    const document = this.documents.get(filename)?.document;\n    if (!document) {\n      ws.close();\n      return;\n    }\n\n    document.addWebSocket(ws as any);\n    ws.on(\"close\", () => {\n      document.removeWebSocket(ws as any);\n    });\n  }\n\n  private watch() {\n    this.watcher = watch(this.directory, {\n      ignoreInitial: false,\n      ignored: (checkPath, stats) => {\n        if (!stats || !stats.isFile()) {\n          return false;\n        }\n        return !micromatch.isMatch(checkPath, this.watchPattern);\n      },\n      persistent: true,\n    });\n    this.watcher\n      .on(\"add\", (fullPath, stats) => {\n        if (!stats || !stats.isFile()) {\n          return;\n        }\n        const relativePath = path.relative(this.directory, fullPath);\n        console.log(`MML Document '${relativePath}' has been added`);\n        const contents = getMmlDocumentContent(fullPath);\n        const document = new EditableNetworkedDOM(\n          url.pathToFileURL(fullPath).toString(),\n          LocalObservableDOMFactory,\n        );\n        document.load(contents);\n\n        const currentData = {\n          documentPath: fullPath,\n          document,\n        };\n        this.documents.set(relativePath, currentData);\n      })\n      .on(\"change\", (fullPath) => {\n        const relativePath = path.relative(this.directory, fullPath);\n        console.log(`MML Document '${relativePath}' has been changed`);\n        const contents = getMmlDocumentContent(fullPath);\n        const documentState = this.documents.get(relativePath);\n        if (!documentState) {\n          console.error(`MML Document '${relativePath}' not found`);\n          return;\n        }\n        documentState.document.load(contents);\n      })\n      .on(\"unlink\", (fullPath) => {\n        const relativePath = path.relative(this.directory, fullPath);\n        console.log(`MML Document '${relativePath}' has been removed`);\n        const documentState = this.documents.get(relativePath);\n        if (!documentState) {\n          console.error(`MML Document '${relativePath}' not found`);\n          return;\n        }\n        documentState.document.dispose();\n        this.documents.delete(relativePath);\n      })\n      .on(\"error\", (error) => {\n        console.error(\"Error whilst watching directory\", error);\n      });\n  }\n}\n", "import {\n  UserData,\n  UserNetworkingServer,\n  UserNetworkingServerError,\n} from \"@mml-io/3d-web-user-networking\";\nimport cors from \"cors\";\nimport express from \"express\";\nimport enableWs from \"express-ws\";\nimport ws from \"ws\";\n\nimport { MMLDocumentsServer } from \"./MMLDocumentsServer\";\nimport { websocketDirectoryChangeListener } from \"./websocketDirectoryChangeListener\";\n\ntype UserAuthenticator = {\n  generateAuthorizedSessionToken(req: express.Request): Promise<string | null>;\n  getClientIdForSessionToken: (sessionToken: string) => {\n    id: number;\n  } | null;\n  onClientConnect(\n    clientId: number,\n    sessionToken: string,\n    userIdentityPresentedOnConnection?: UserData,\n  ): Promise<UserData | true | Error> | UserData | true | Error;\n  onClientUserIdentityUpdate(clientId: number, userIdentity: UserData): UserData | true | Error;\n  onClientDisconnect(clientId: number): void;\n};\n\nexport const defaultSessionTokenPlaceholder = \"SESSION.TOKEN.PLACEHOLDER\";\n\nexport type Networked3dWebExperienceServerConfig = {\n  networkPath: string;\n  webClientServing: {\n    indexUrl: string;\n    indexContent: string;\n    sessionTokenPlaceholder?: string;\n\n    clientBuildDir: string;\n    clientUrl: string;\n    clientWatchWebsocketPath?: string;\n  };\n  enableChat?: boolean;\n  assetServing?: {\n    assetsDir: string;\n    assetsUrl: string;\n  };\n  mmlServing?: {\n    documentsWatchPath: string;\n    documentsDirectoryRoot: string;\n    documentsUrl: string;\n  };\n  userAuthenticator: UserAuthenticator;\n};\n\nexport class Networked3dWebExperienceServer {\n  public userNetworkingServer: UserNetworkingServer;\n\n  public mmlDocumentsServer?: MMLDocumentsServer;\n\n  constructor(private config: Networked3dWebExperienceServerConfig) {\n    if (this.config.mmlServing) {\n      const { documentsWatchPath, documentsDirectoryRoot } = this.config.mmlServing;\n      this.mmlDocumentsServer = new MMLDocumentsServer(documentsDirectoryRoot, documentsWatchPath);\n    }\n\n    this.userNetworkingServer = new UserNetworkingServer({\n      legacyAdapterEnabled: true,\n      onClientConnect: (\n        clientId: number,\n        sessionToken: string,\n        userIdentityPresentedOnConnection?: UserData,\n      ): Promise<UserData | true | Error> | UserData | true | Error => {\n        return this.config.userAuthenticator.onClientConnect(\n          clientId,\n          sessionToken,\n          userIdentityPresentedOnConnection,\n        );\n      },\n      onClientUserIdentityUpdate: (\n        clientId: number,\n        userIdentity: UserData,\n      ): UserData | true | Error => {\n        // Called whenever a user connects or updates their character/identity\n        return this.config.userAuthenticator.onClientUserIdentityUpdate(clientId, userIdentity);\n      },\n      onClientDisconnect: (clientId: number): void => {\n        this.config.userAuthenticator.onClientDisconnect(clientId);\n      },\n    });\n  }\n\n  public updateUserCharacter(clientId: number, userData: UserData) {\n    console.log(`Initiate server-side update of client ${clientId}`);\n    this.userNetworkingServer.updateUserCharacter(clientId, userData);\n  }\n\n  public dispose(error?: UserNetworkingServerError) {\n    this.userNetworkingServer.dispose(error);\n    if (this.mmlDocumentsServer) {\n      this.mmlDocumentsServer.dispose();\n    }\n  }\n\n  registerExpressRoutes(app: enableWs.Application) {\n    app.ws(this.config.networkPath, (ws) => {\n      this.userNetworkingServer.connectClient(ws as unknown as WebSocket);\n    });\n\n    const webClientServing = this.config.webClientServing;\n    if (webClientServing) {\n      app.get(webClientServing.indexUrl, async (req: express.Request, res: express.Response) => {\n        const token = await this.config.userAuthenticator.generateAuthorizedSessionToken(req);\n        if (!token) {\n          res.send(\"Error: Could not generate token\");\n          return;\n        }\n        const authorizedDemoIndexContent = webClientServing.indexContent.replace(\n          webClientServing.sessionTokenPlaceholder || defaultSessionTokenPlaceholder,\n          token,\n        );\n        res.send(authorizedDemoIndexContent);\n      });\n\n      app.use(webClientServing.clientUrl, express.static(webClientServing.clientBuildDir));\n      if (webClientServing.clientWatchWebsocketPath) {\n        websocketDirectoryChangeListener(app, {\n          directory: webClientServing.clientBuildDir,\n          websocketPath: webClientServing.clientWatchWebsocketPath,\n        });\n      }\n    }\n\n    const mmlDocumentsServer = this.mmlDocumentsServer;\n    const mmlServing = this.config.mmlServing;\n    // Handle example document sockets\n    if (mmlServing && mmlDocumentsServer) {\n      app.ws(`${mmlServing.documentsUrl}*`, (ws: ws.WebSocket, req: express.Request) => {\n        const path = req.params[0];\n        console.log(\"document requested\", { path });\n        mmlDocumentsServer.handle(path, ws);\n      });\n    }\n\n    if (this.config.assetServing) {\n      // Serve assets with CORS allowing all origins\n      app.use(\n        this.config.assetServing.assetsUrl,\n        cors(),\n        express.static(this.config.assetServing.assetsDir),\n      );\n    }\n  }\n}\n", "import { watch } from \"chokidar\";\nimport enableWs from \"express-ws\";\nimport WebSocket from \"ws\";\n\nexport function websocketDirectoryChangeListener(\n  app: enableWs.Application,\n  options: {\n    directory: string;\n    websocketPath: string;\n  },\n) {\n  const listeningClients = new Set<WebSocket>();\n  watch(options.directory).on(\"all\", () => {\n    for (const client of listeningClients) {\n      client.send(\"change\");\n    }\n  });\n  // Create an event-source that updates whenever the build folder gets modified\n  app.ws(options.websocketPath, (ws: WebSocket) => {\n    listeningClients.add(ws);\n    ws.on(\"close\", () => {\n      listeningClients.delete(ws);\n    });\n  });\n}\n"],
  "mappings": "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",
  "names": ["watch", "path"]
}
