#!/usr/bin/env bash
set -euo pipefail

# Usage check
if [[ $# -lt 1 ]]; then 
    echo "Usage: omarchy-install-handler omarchy://webappinstall?name=...&url=...&icon=..."
    exit 1
fi

URI="$1"

# Validate URI format
case "$URI" in 
    omarchy://webappinstall*|omarchy://install*)
        ;;
    *)
        echo "Unsupported URI format"
        exit 1
        ;;
esac

# URL decode function
urldecode() {
    local d="${1//+/ }"
    printf '%b' "${d//%/\\x}"
}

# Parameter extraction function
getp() {
    local k="$1"
    printf '%s' "$URI" | sed -n "s/.*[?&]${k}=\([^&]*\).*$/\1/p"
}

# Extract parameters
APP_NAME="$(urldecode "$(getp name)")"
APP_URL="$(urldecode "$(getp url)")"
ICON_REF="$(urldecode "$(getp icon)")"
CUSTOM_EXEC="$(urldecode "$(getp exec)")"
MIME_TYPES="$(urldecode "$(getp mimeTypes)")"

# Validate required parameters
if [[ -z "$APP_NAME" || -z "$APP_URL" || -z "$ICON_REF" ]]; then
    echo "Missing required parameters: name, url, icon"
    exit 1
fi

# Validate custom exec if provided
if [[ -n "$CUSTOM_EXEC" ]] && ! command -v "$CUSTOM_EXEC" >/dev/null 2>&1; then
    echo "Warning: Custom executable '$CUSTOM_EXEC' not found in PATH"
fi

# Create safe filename from app name
SAFE_NAME=$(echo "$APP_NAME" | sed 's/[^a-zA-Z0-9._-]/_/g')
DESKTOP_FILE="$HOME/.local/share/applications/${SAFE_NAME}.desktop"

# Check if desktop entry already exists
if [[ -f "$DESKTOP_FILE" ]]; then
    echo "Desktop entry already exists: $DESKTOP_FILE"
    echo "Overwriting existing entry..."
fi

# Ensure applications directory exists
mkdir -p "$HOME/.local/share/applications"

# Create desktop entry
cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=Web application
Exec=$CUSTOM_EXEC %u
Icon=$ICON_REF
Type=Application
StartupNotify=true
Categories=Network;WebBrowser;
MimeType=$MIME_TYPES
EOF

# Make desktop entry executable
chmod +x "$DESKTOP_FILE"

# Update desktop database
update-desktop-database "$HOME/.local/share/applications" 2>/dev/null || true

echo "âœ… Installed $APP_NAME successfully!"
echo "Desktop entry created: $DESKTOP_FILE"
