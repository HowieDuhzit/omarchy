{
  "version": 3,
  "sources": ["../src/index.ts", "../src/BasicUserAuthenticator.ts"],
  "sourcesContent": ["import fs from \"fs\";\nimport path from \"path\";\nimport url from \"url\";\n\nimport {\n  Networked3dWebExperienceServer,\n  Networked3dWebExperienceServerConfig,\n} from \"@mml-io/3d-web-experience-server\";\nimport type { CharacterDescription } from \"@mml-io/3d-web-user-networking\";\nimport express from \"express\";\nimport enableWs from \"express-ws\";\n\nimport { BasicUserAuthenticator } from \"./BasicUserAuthenticator\";\n\nconst dirname = url.fileURLToPath(new URL(\".\", import.meta.url));\n\nconst PORT = process.env.PORT || 3000;\n\n// Default avatar - simple bot model\nconst characterDescription: CharacterDescription = {\n  meshFileUrl: \"https://public.mml.io/bot.glb\",\n};\n\nconst userAuthenticator = new BasicUserAuthenticator(characterDescription, {\n  devAllowUnrecognizedSessions: true,\n});\n\nconst webClientBuildDir = path.join(dirname, \"../../client/build/\");\nconst indexContent = fs.readFileSync(path.join(webClientBuildDir, \"index.html\"), \"utf8\");\nconst mmlDocumentsDirectoryRoot = path.resolve(dirname, \"../mml-documents\");\nconst mmlDocumentsWatchPath = \"**/*.html\";\n\nconst { app } = enableWs(express());\napp.enable(\"trust proxy\");\n\nconst networked3dWebExperienceServer = new Networked3dWebExperienceServer({\n  networkPath: \"/network\",\n  userAuthenticator,\n  mmlServing: {\n    documentsWatchPath: mmlDocumentsWatchPath,\n    documentsDirectoryRoot: mmlDocumentsDirectoryRoot,\n    documentsUrl: \"/mml-documents/\",\n  },\n  webClientServing: {\n    indexUrl: \"/\",\n    indexContent,\n    clientBuildDir: webClientBuildDir,\n    clientUrl: \"/web-client/\",\n    clientWatchWebsocketPath:\n      process.env.NODE_ENV !== \"production\" ? \"/web-client-build\" : undefined,\n  },\n  enableChat: true,\n} satisfies Networked3dWebExperienceServerConfig);\n\nnetworked3dWebExperienceServer.registerExpressRoutes(app);\n\n// Start listening\nconsole.log(`\n===========================================\n   MINESWEPT - 3D Multiplayer Minesweeper\n===========================================\n   Server running on http://localhost:${PORT}\n===========================================\n`);\napp.listen(PORT);\n", "import crypto from \"crypto\";\n\nimport type { CharacterDescription, UserData } from \"@mml-io/3d-web-user-networking\";\nimport express from \"express\";\n\nexport type AuthUser = {\n  clientId: number | null;\n  userData?: UserData;\n  sessionToken: string;\n};\n\nexport type BasicUserAuthenticatorOptions = {\n  devAllowUnrecognizedSessions: boolean;\n};\n\nconst defaultOptions: BasicUserAuthenticatorOptions = {\n  devAllowUnrecognizedSessions: false,\n};\n\nexport class BasicUserAuthenticator {\n  private usersByClientId = new Map<number, AuthUser>();\n  private userBySessionToken = new Map<string, AuthUser>();\n\n  constructor(\n    private characterDescription: CharacterDescription,\n    private options: BasicUserAuthenticatorOptions = defaultOptions,\n  ) {}\n\n  public async generateAuthorizedSessionToken(req: express.Request): Promise<string> {\n    const sessionToken = crypto.randomBytes(20).toString(\"hex\");\n    const authUser: AuthUser = {\n      clientId: null,\n      sessionToken,\n    };\n\n    this.userBySessionToken.set(sessionToken, authUser);\n    return sessionToken;\n  }\n\n  public async onClientConnect(\n    clientId: number,\n    sessionToken: string,\n    userIdentityPresentedOnConnection?: UserData,\n  ): Promise<UserData | true | Error> {\n    console.log(`Client ID: ${clientId} joined with token`);\n    let user = this.userBySessionToken.get(sessionToken);\n    if (!user && this.options.devAllowUnrecognizedSessions) {\n      console.warn(`Dev mode: allowing unrecognized session token`);\n      user = {\n        clientId: null,\n        sessionToken,\n      };\n      this.userBySessionToken.set(sessionToken, user);\n    }\n\n    if (!user) {\n      console.error(`Invalid initial user-update for clientId ${clientId}, unknown session`);\n      return new Error(`Invalid initial user-update for clientId ${clientId}, unknown session`);\n    }\n\n    if (user.clientId !== null) {\n      console.error(`Session token already connected`);\n      return new Error(`Session token already connected`);\n    }\n\n    user.clientId = clientId;\n    user.userData = {\n      username: `Player ${clientId}`,\n      characterDescription:\n        userIdentityPresentedOnConnection?.characterDescription ?? this.characterDescription,\n      colors: userIdentityPresentedOnConnection?.colors ?? [],\n    };\n    console.log(`Client ID: ${clientId} connected with user data`, user.userData);\n    this.usersByClientId.set(clientId, user);\n    return user.userData;\n  }\n\n  public getClientIdForSessionToken(sessionToken: string): { id: number } | null {\n    const user = this.userBySessionToken.get(sessionToken);\n    if (!user) {\n      return null;\n    }\n    if (user.clientId === null) {\n      return null;\n    }\n    return { id: user.clientId };\n  }\n\n  public onClientUserIdentityUpdate(clientId: number, msg: UserData): UserData | true | Error {\n    const user = this.usersByClientId.get(clientId);\n\n    if (!user) {\n      return new Error(`onClientUserIdentityUpdate - unknown clientId ${clientId}`);\n    }\n\n    if (!user.userData) {\n      return new Error(`onClientUserIdentityUpdate - no user data for clientId ${clientId}`);\n    }\n\n    const newUserData: UserData = {\n      username: msg.username ?? user.userData.username,\n      characterDescription: msg.characterDescription ?? user.userData.characterDescription,\n      colors: msg.colors ?? user.userData.colors,\n    };\n\n    this.usersByClientId.set(clientId, { ...user, userData: newUserData });\n    return newUserData;\n  }\n\n  public onClientDisconnect(clientId: number) {\n    console.log(`Remove user-session for ${clientId}`);\n    const userData = this.usersByClientId.get(clientId);\n    if (userData) {\n      userData.clientId = null;\n      this.usersByClientId.delete(clientId);\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": ["characterDescription"]
}
